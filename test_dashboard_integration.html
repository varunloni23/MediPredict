<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stats { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value { font-size: 2em; font-weight: bold; }
        .healthy { color: #10B981; }
        .at-risk { color: #F59E0B; }
        .needs-maintenance { color: #EF4444; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <h1>Dashboard Integration Test</h1>
    
    <div class="stats">
        <div class="stat-card">
            <h3>Total Devices</h3>
            <div class="stat-value healthy" id="total-devices">-</div>
        </div>
        <div class="stat-card">
            <h3>Devices at Risk</h3>
            <div class="stat-value at-risk" id="at-risk">-</div>
        </div>
        <div class="stat-card">
            <h3>Needs Maintenance</h3>
            <div class="stat-value needs-maintenance" id="needs-maintenance">-</div>
        </div>
    </div>
    
    <h2>Recent Alerts</h2>
    <table id="alerts-table">
        <thead>
            <tr>
                <th>Device ID</th>
                <th>Device Name</th>
                <th>Status</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="4" style="text-align: center;">Loading...</td>
            </tr>
        </tbody>
    </table>
    
    <script>
        async function loadDashboardData() {
            try {
                // Fetch devices
                const devicesResponse = await fetch('http://localhost:8001/api/devices/')
                const devices = await devicesResponse.json()
                
                // Fetch predictions
                const predictionsResponse = await fetch('http://localhost:8001/api/predictions/')
                const predictions = await predictionsResponse.json()
                
                // Calculate stats
                const healthyDevices = devices.filter(device => {
                    const devicePredictions = predictions.filter(p => p.device_id === device.device_id)
                    if (devicePredictions.length > 0) {
                        return devicePredictions[0].predicted_status === 'healthy'
                    }
                    return false
                }).length
                
                const atRiskDevices = devices.filter(device => {
                    const devicePredictions = predictions.filter(p => p.device_id === device.device_id)
                    if (devicePredictions.length > 0) {
                        return devicePredictions[0].predicted_status === 'at_risk'
                    }
                    return false
                }).length
                
                const needsMaintenanceDevices = devices.filter(device => {
                    const devicePredictions = predictions.filter(p => p.device_id === device.device_id)
                    if (devicePredictions.length > 0) {
                        return devicePredictions[0].predicted_status === 'needs_maintenance'
                    }
                    return false
                }).length
                
                // Update UI
                document.getElementById('total-devices').textContent = devices.length
                document.getElementById('at-risk').textContent = atRiskDevices
                document.getElementById('needs-maintenance').textContent = needsMaintenanceDevices
                
                // Update alerts table
                const recentPredictions = predictions
                    .sort((a, b) => new Date(b.prediction_timestamp) - new Date(a.prediction_timestamp))
                    .slice(0, 5)
                    .map(pred => {
                        const device = devices.find(d => d.device_id === pred.device_id) || { name: 'Unknown Device' }
                        return {
                            deviceId: pred.device_id,
                            deviceName: device.name,
                            status: pred.predicted_status,
                            lastUpdated: new Date(pred.prediction_timestamp).toLocaleString()
                        }
                    })
                
                const tableBody = document.querySelector('#alerts-table tbody')
                tableBody.innerHTML = ''
                
                if (recentPredictions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No alerts found</td></tr>'
                    return
                }
                
                recentPredictions.forEach(alert => {
                    const row = document.createElement('tr')
                    row.innerHTML = `
                        <td>${alert.deviceId}</td>
                        <td>${alert.deviceName}</td>
                        <td><span class="${alert.status.replace('_', '-')}">${alert.status.replace('_', ' ')}</span></td>
                        <td>${alert.lastUpdated}</td>
                    `
                    tableBody.appendChild(row)
                })
                
                console.log('Dashboard data loaded successfully')
            } catch (error) {
                console.error('Error loading dashboard data:', error)
                document.querySelector('#alerts-table tbody').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: red;">Error loading data</td></tr>'
            }
        }
        
        // Load data when page loads
        window.addEventListener('load', loadDashboardData)
    </script>
</body>
</html>